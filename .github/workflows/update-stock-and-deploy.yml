name: ğŸ”„ Update Stock & Deploy

on:
  # Ejecutar manualmente desde GitHub Actions
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Forzar actualizaciÃ³n aunque no haya cambios'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      skip_deploy:
        description: 'Omitir despliegue a GitHub Pages'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

  # Ejecutar diariamente a las 6 AM UTC (1 AM Lima)
  schedule:
    - cron: '0 6 * * *'

  # TambiÃ©n ejecutar en push a main (opcional)
  push:
    branches: [ main ]
    paths:
      - 'data-processor/**'
      - '.github/workflows/update-stock-and-deploy.yml'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "stock-update-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  update-stock:
    name: ğŸ“Š Update Stock Data
    runs-on: windows-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
      changes: ${{ steps.check_changes.outputs.changes }}

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        # Necesitamos acceso completo para hacer commits
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ“¦ Install data-processor dependencies
      run: |
        cd data-processor
        npm ci
        cd ..

    - name: ğŸ“Š Download latest stock data
      run: |
        # AquÃ­ irÃ­a la lÃ³gica para descargar el archivo de stock mÃ¡s reciente
        # Por ejemplo, desde un servidor FTP, API, o compartir de red
        echo "ğŸ“¥ Descargando datos de stock mÃ¡s recientes..."

        # SimulaciÃ³n - en producciÃ³n esto serÃ­a:
        # - ConexiÃ³n a servidor de base de datos
        # - Descarga desde FTP/SFTP
        # - API call a sistema de gestiÃ³n
        # - Copia desde directorio compartido

        # Por ahora, verificamos que el archivo existe
        $stockPath = "C:\Users\ccusi\Documents\Proyect_Coder\gestion_de_stock\procesamiento\data_stock_completo.xlsx"
        if (Test-Path $stockPath) {
          Write-Host "âœ… Archivo de stock encontrado: $stockPath"
          $fileInfo = Get-Item $stockPath
          Write-Host "ğŸ“… Ãšltima modificaciÃ³n: $($fileInfo.LastWriteTime)"
          Write-Host "ğŸ“ TamaÃ±o: $($fileInfo.Length) bytes"
        } else {
          Write-Host "âŒ Archivo de stock NO encontrado: $stockPath"
          exit 1
        }

    - name: ğŸ”„ Process stock data
      run: |
        Write-Host "ğŸš€ Iniciando procesamiento de datos..."
        cd data-processor
        npm run process
        cd ..
        Write-Host "âœ… Procesamiento completado"

    - name: ğŸ” Check for changes
      id: check_changes
      run: |
        $hasChanges = git status --porcelain public/*.json public/last-update.txt
        if ($hasChanges) {
          Write-Host "ğŸ“ Cambios detectados:"
          Write-Host $hasChanges
          echo "has_changes=true" >> $env:GITHUB_OUTPUT
          echo "changes<<EOF" >> $env:GITHUB_OUTPUT
          echo "$hasChanges" >> $env:GITHUB_OUTPUT
          echo "EOF" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "ğŸ“‹ No hay cambios en los datos"
          echo "has_changes=false" >> $env:GITHUB_OUTPUT
        }

    - name: ğŸ’¾ Commit stock updates
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        Write-Host "ğŸ’¾ Creando commit de actualizaciÃ³n de stock..."

        # Configurar git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Agregar archivos
        git add public/*.json public/last-update.txt data-processor/outputs/*.json

        # Crear mensaje de commit
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        $commitMessage = "ğŸ”„ ActualizaciÃ³n automÃ¡tica de stock - $timestamp`n`nâœ… Datos procesados desde sistema de gestiÃ³n`nğŸ“Š Cambios detectados en archivos JSON`nâ° Timestamp: $timestamp UTC`n`nGenerado automÃ¡ticamente por GitHub Actions"

        # Crear commit
        git commit -m "$commitMessage"
        Write-Host "âœ… Commit creado exitosamente"

    - name: ğŸ“¤ Push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        Write-Host "ğŸ“¤ Subiendo cambios a repositorio..."
        git push origin main
        Write-Host "âœ… Cambios subidos exitosamente"

  build-and-deploy:
    name: ğŸš€ Build & Deploy
    needs: update-stock
    if: needs.update-stock.result == 'success'
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout with updated data
      uses: actions/checkout@v4
      with:
        # Asegurarse de tener los Ãºltimos cambios
        fetch-depth: 0

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build project
      run: npm run build

    - name: ğŸ“‹ Verify build
      run: |
        if [ ! -d "dist" ]; then
          echo "âŒ Build failed - dist/ directory not found!"
          exit 1
        fi
        echo "âœ… Build successful"
        ls -la dist/

    - name: ğŸ“¤ Upload build artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist

    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: ğŸ‰ Deployment complete
      run: |
        echo "ğŸ‰ Â¡Despliegue completado exitosamente!"
        echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“… Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"