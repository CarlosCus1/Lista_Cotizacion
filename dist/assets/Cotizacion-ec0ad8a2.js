import{u as E,c as $,j as e}from"./index-1e243175.js";import{r as c}from"./vendor-b1791c80.js";import{u as g,w as O}from"./utils-6c4e335f.js";const U="PEN",I=.18;function y(i){return isFinite(i)?parseFloat(i.toFixed(2)):0}function r(i){return new Intl.NumberFormat("es-PE",{style:"currency",currency:U}).format(i||0)}function J(i){if(!i)return"";const p=new Date-i,f=Math.floor(p/(1e3*60)),N=Math.floor(p/(1e3*60*60)),h=Math.floor(p/(1e3*60*60*24));return f<60?`hace ${f} min`:N<24?`hace ${N}h`:`hace ${h} días`}function Q({onBack:i,catalogData:v=[],descOcultos:p=[]}){const[f,N]=c.useState({ruc:"",nombre:"",oc:""}),[h,b]=c.useState([]),[R,_]=c.useState(""),[w,q]=c.useState("TODAS"),[B,S]=c.useState(!1),[k,C]=c.useState(null);c.useEffect(()=>{const t=localStorage.getItem("cotizacion_seleccion");if(t)try{const{items:s,timestamp:a}=JSON.parse(t),l=24*60*60*1e3;Date.now()-a<l&&(b(s),S(!0),C(new Date(a)))}catch(s){console.warn("Error loading saved selection:",s)}},[]),c.useEffect(()=>{if(h.length>0){const t={items:h,timestamp:Date.now()};localStorage.setItem("cotizacion_seleccion",JSON.stringify(t)),S(!0),C(new Date)}else localStorage.removeItem("cotizacion_seleccion"),S(!1),C(null)},[h]);const M=E(R,300),P=c.useMemo(()=>{let t=v;if(w!=="TODAS"&&(t=t.filter(s=>s.linea===w)),M.trim()){const s=M.trim().toLowerCase();t=t.filter(a=>String(a.codigo).toLowerCase().includes(s)||String(a.nombre).toLowerCase().includes(s))}return t},[v,w,M]),x=c.useMemo(()=>h.map(t=>{const s={...t.product,descManual1:t.manualDiscounts[0]||0,descManual2:t.manualDiscounts[1]||0},{neto:a,priceAfterHiddenDiscounts:l,effectiveHiddenDiscount:d,effectiveProductDiscount:u}=$(s,p),n=a,m=y(n*t.quantity),V=y(m*(1+I));return{...t.product,quantity:t.quantity,manualDiscounts:t.manualDiscounts,descSuma01:d,descSuma02:u,precioDescSuma01:l,unitPrice:n,totalSinIgv:m,totalConIgv:V}}),[h,p]),D=c.useMemo(()=>{const t=x.reduce((l,d)=>l+d.totalSinIgv,0),s=y(t),a=y(s*(1+I));return{subtotal:y(t),totalSinIgv:s,totalConIgv:a}},[x]),T=t=>{b(s=>s.some(l=>l.product.idx===t.idx)?s.filter(l=>l.product.idx!==t.idx):[...s,{product:t,quantity:1,manualDiscounts:[0,0]}])},F=(t,s,a)=>{b(l=>l.map(d=>{if(d.product.idx===t){const u={...d};if(s==="quantity")u.quantity=Math.max(1,parseInt(a,10)||1);else if(s.startsWith("manualDiscount")){const n=parseInt(s.replace("manualDiscount",""),10),m=[...u.manualDiscounts];m[n]=Math.max(0,parseFloat(a)||0),u.manualDiscounts=m}return u}return d}))},z=(t,s)=>{N(a=>({...a,[t]:s}))},G=()=>{if(!x.length)return;const t=g.book_new(),s=[["RUC",s.ruc],["Cliente",s.nombre],["OC",s.oc],[]],a=["Código","Cantidad","Precio Base","Desc01(suma)","Desc02(suma)","Desc Total Sumado","Total s/IGV","Total c/IGV"],l=x.map(o=>[o.codigo,o.quantity,o.precioBase,o.descSuma01,o.descSuma02,o.descSuma01+o.descSuma02,o.totalSinIgv,o.totalConIgv]),d=[[],["TOTAL s/IGV","","","","",D.totalSinIgv],["TOTAL c/IGV","","","","",D.totalConIgv]],u=[...s,a,...l,...d],n=g.aoa_to_sheet(u);n["!autofilter"]={ref:g.encode_range(g.decode_range(n["!ref"]))},n["!freeze"]={xSplit:0,ySplit:5},n["!cols"]=[{wch:14},{wch:10},{wch:14},{wch:12},{wch:12},{wch:16},{wch:14},{wch:14}];const m=g.decode_range("A5:G5");for(let o=m.s.c;o<=m.e.c;o++){const L=n[g.encode_cell({r:4,c:o})];L&&(L.s={font:{bold:!0},fill:{fgColor:{rgb:"FFE6E6FA"}}})}const V="Cotizacion";g.book_append_sheet(t,n,V);const j=new Date,H=`${j.getFullYear()}-${String(j.getMonth()+1).padStart(2,"0")}-${String(j.getDate()).padStart(2,"0")}_${String(j.getHours()).padStart(2,"0")}-${String(j.getMinutes()).padStart(2,"0")}`,A=`cotizacion_${s.ruc||"sin-ruc"}_${H}.xlsx`;O(t,A)};return e.jsxs("div",{className:"min-h-screen bg-gray-100",children:[e.jsx("header",{className:"bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:i,className:"inline-flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-colors",children:[e.jsx("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z",clipRule:"evenodd"})}),"Volver al Catálogo"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"Nueva Cotización"})]})})})}),e.jsxs("main",{className:"max-w-7xl mx-auto px-4 py-6",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-6 border-2 border-blue-100",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx("svg",{className:"w-6 h-6 text-blue-600",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm3 2a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z",clipRule:"evenodd"})}),"Datos del Cliente"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"RUC"}),e.jsx("input",{type:"text",className:"w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors",placeholder:"Ingrese RUC",value:f.ruc,onChange:t=>z("ruc",t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cliente"}),e.jsx("input",{type:"text",className:"w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors",placeholder:"Nombre del cliente",value:f.nombre,onChange:t=>z("nombre",t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Orden de Compra"}),e.jsx("input",{type:"text",className:"w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors",placeholder:"OC-001",value:f.oc,onChange:t=>z("oc",t.target.value)})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg border-2 border-blue-100 overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Seleccionar Productos"}),B&&k&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-200",children:[e.jsx("svg",{className:"w-3 h-3",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),e.jsxs("span",{children:["Selección guardada ",J(k)]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mb-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",className:"w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors",placeholder:"Buscar producto por código o nombre...",value:R,onChange:t=>_(t.target.value)})}),e.jsx("div",{className:"w-full sm:w-48",children:e.jsxs("select",{className:"w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors",value:w,onChange:t=>q(t.target.value),children:[e.jsx("option",{value:"TODAS",children:"Todas las líneas"}),[...new Set(v.map(t=>t.linea).filter(Boolean))].sort().map(t=>e.jsx("option",{value:t,children:t},t))]})})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm text-left text-gray-500",children:[e.jsx("thead",{className:"text-xs text-gray-700 uppercase bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:e.jsx("input",{type:"checkbox",onChange:t=>{if(t.target.checked){const s=P.map(a=>({product:a,quantity:1,manualDiscounts:[0,0]}));b(s)}else b([])},className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"})}),e.jsx("th",{scope:"col",className:"px-4 py-3",children:"Código"}),e.jsx("th",{scope:"col",className:"px-4 py-3",children:"Nombre"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:"Stock"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:"Cantidad"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-right",children:"Precio s/IGV"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-right",children:"Precio c/IGV"})]})}),e.jsx("tbody",{children:P.map(t=>{const s=x.find(l=>l.idx===t.idx),a=!!s;return e.jsxs("tr",{className:`border-b hover:bg-gray-50 ${a?"bg-blue-50":""}`,children:[e.jsx("td",{className:"px-4 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:a,onChange:()=>T(t),className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"})}),e.jsx("td",{className:"px-4 py-2 font-mono font-medium text-gray-900",children:t.codigo}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("div",{className:"font-medium text-sm leading-tight break-words line-clamp-2 hover:line-clamp-none hover:whitespace-normal transition-all duration-200 cursor-help",title:t.nombre,children:t.nombre})}),e.jsx("td",{className:"px-4 py-2 text-center",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-bold ${(t.stock||0)>20?"bg-green-100 text-green-800":(t.stock||0)>10?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:t.stock||0})}),e.jsx("td",{className:"px-4 py-2 text-center",children:a?e.jsx("input",{type:"number",min:"1",className:"w-20 border border-gray-300 rounded-md px-2 py-1 text-center font-mono",value:Math.round(s.quantity),onChange:l=>F(t.idx,"quantity",l.target.value)}):e.jsx("span",{className:"text-gray-400",children:"-"})}),e.jsx("td",{className:"px-4 py-2 text-right font-mono",children:r(a?s.unitPrice:t.precioBase)}),e.jsx("td",{className:"px-4 py-2 text-right font-mono",children:r(a?s.unitPrice*(1+I):t.precioBase*(1+I))})]},t.idx)})})]})})]}),x.length>0&&e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-6 border-2 border-green-100",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:"Resumen de Cotización"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm text-left text-gray-500",children:[e.jsx("thead",{className:"text-xs text-gray-700 uppercase bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-4 py-3",children:"Código"}),e.jsx("th",{scope:"col",className:"px-4 py-3",children:"Nombre"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:"Cantidad"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-right",children:"Precio Base"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:"Desc. Suma 1 (%)"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:"Desc. Suma 2 (%)"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-right",children:"Precio Unit. s/IGV"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-right",children:"Total s/IGV"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-right",children:"Total c/IGV"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:"Acción"})]})}),e.jsx("tbody",{children:x.map(t=>e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 font-mono font-medium text-gray-900",children:t.codigo}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("div",{className:"font-medium text-sm leading-tight break-words line-clamp-2 hover:line-clamp-none hover:whitespace-normal transition-all duration-200 cursor-help",title:t.nombre,children:t.nombre})}),e.jsx("td",{className:"px-4 py-2 text-center font-mono",children:Math.round(t.quantity)}),e.jsx("td",{className:"px-4 py-2 text-right font-mono",children:r(t.precioBase)}),e.jsx("td",{className:"px-4 py-2 text-center font-mono text-sm",children:t.descSuma01?Math.round(t.descSuma01).toFixed(0)+".00%":"0.00%"}),e.jsx("td",{className:"px-4 py-2 text-center font-mono text-sm",children:t.descSuma02?(Math.round(t.descSuma02*100)/100).toFixed(2)+"%":"0.00%"}),e.jsx("td",{className:"px-4 py-2 text-right font-mono",children:r(t.unitPrice)}),e.jsx("td",{className:"px-4 py-2 text-right font-mono font-bold text-green-700",children:r(t.totalSinIgv)}),e.jsx("td",{className:"px-4 py-2 text-right font-mono font-bold text-blue-700",children:r(t.totalConIgv)}),e.jsx("td",{className:"px-4 py-2 text-center",children:e.jsx("button",{onClick:()=>T(t),className:"text-red-500 hover:text-red-700",children:e.jsx("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})})})})]},t.idx))})]})})]}),x.length>0&&e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100",children:[e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center text-lg font-bold border-b border-gray-300 pb-2",children:[e.jsx("span",{className:"text-gray-800",children:"Total s/IGV:"}),e.jsx("span",{className:"text-green-600",children:r(D.totalSinIgv)})]}),e.jsxs("div",{className:"flex justify-between items-center text-xl font-bold",children:[e.jsx("span",{className:"text-gray-800",children:"Total c/IGV:"}),e.jsx("span",{className:"text-blue-600",children:r(D.totalConIgv)})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>{b([]),localStorage.removeItem("cotizacion_seleccion"),S(!1),C(null)},className:"flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}),"Limpiar Selección"]}),e.jsxs("button",{onClick:G,className:"flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z",clipRule:"evenodd"})}),"Exportar XLSX"]})]})]})]})]})}export{Q as default};
