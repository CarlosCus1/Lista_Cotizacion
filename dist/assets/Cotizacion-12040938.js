import{u as W,c as Q,t as j,j as e,f as Y,a as i}from"./index-02682db5.js";import{r}from"./vendor-b1791c80.js";import{u,w as K}from"./utils-6c4e335f.js";const C=.18;function te({onBack:q,catalogData:D=[],descOcultos:z=[]}){const[c,$]=r.useState({ruc:"",nombre:"",oc:""}),A=t=>{const s=t.replace(/\D/g,"");return s.length===11||s.length===8},H=t=>/^\d*$/.test(t),M=c.ruc===""||A(c.ruc),R=c.oc===""||H(c.oc),[p,h]=r.useState([]),[k,F]=r.useState(""),[y,T]=r.useState("TODAS"),[B,v]=r.useState(!1),[V,N]=r.useState(null);r.useEffect(()=>{const t=localStorage.getItem("cotizacion_seleccion");if(t)try{const{items:s,timestamp:a}=JSON.parse(t),o=24*60*60*1e3;Date.now()-a<o&&(h(s),v(!0),N(new Date(a)))}catch(s){console.warn("Error loading saved selection:",s)}},[]),r.useEffect(()=>{if(p.length>0){const t={items:p,timestamp:Date.now()};localStorage.setItem("cotizacion_seleccion",JSON.stringify(t)),v(!0),N(new Date)}else localStorage.removeItem("cotizacion_seleccion"),v(!1),N(null)},[p]);const I=W(k,300),P=r.useMemo(()=>{let t=D;if(y!=="TODAS"&&(t=t.filter(s=>s.linea===y)),I.trim()){const s=I.trim().toLowerCase();t=t.filter(a=>String(a.codigo).toLowerCase().includes(s)||String(a.nombre).toLowerCase().includes(s))}return t},[D,y,I]),m=r.useMemo(()=>p.map(t=>{const s={...t.product,descManual1:t.manualDiscounts[0]||0,descManual2:t.manualDiscounts[1]||0},{neto:a,priceAfterHiddenDiscounts:o,effectiveHiddenDiscount:d,effectiveProductDiscount:n}=Q(s,z),g=a,x=j(t.quantity*a),S=j(x*(1+C));return{...t.product,quantity:t.quantity,manualDiscounts:t.manualDiscounts,descSuma01:d,descSuma02:n,precioDescSuma01:o,unitPrice:g,totalSinIgv:x,totalConIgv:S}}),[p,z]),w=r.useMemo(()=>{const t=m.reduce((o,d)=>o+d.totalSinIgv,0),s=j(t),a=j(s*(1+C));return{subtotal:j(t),totalSinIgv:s,totalConIgv:a}},[m]),L=t=>{h(s=>s.some(o=>o.product.idx===t.idx)?s.filter(o=>o.product.idx!==t.idx):[...s,{product:t,quantity:1,manualDiscounts:[0,0]}])},E=(t,s,a)=>{h(o=>o.map(d=>{if(d.product.idx===t){const n={...d};if(s==="quantity")n.quantity=Math.max(1,parseInt(a,10)||1);else if(s.startsWith("manualDiscount")){const g=parseInt(s.replace("manualDiscount",""),10),x=[...n.manualDiscounts];x[g]=Math.max(0,parseFloat(a)||0),n.manualDiscounts=x}return n}return d}))},_=(t,s)=>{let a=s;t==="ruc"?(a=s.replace(/\D/g,""),a.length>11&&(a=a.slice(0,11))):t==="oc"&&(a=s.replace(/\D/g,"")),$(o=>({...o,[t]:a}))},O=()=>{if(!m.length)return;const t=u.book_new(),s=["ruc","oc","codigo","nombre","cantidad","precio_lista","desc_cliente_%","desc_fijos_%","total_neto","con_igv"],a=m.map(l=>[c.ruc||"",c.oc||"",l.codigo,l.nombre,l.quantity,l.precio_lista,l.descSuma01?Math.round(l.descSuma01*100)/100:0,l.descSuma02?Math.round(l.descSuma02*100)/100:0,l.totalSinIgv,l.totalConIgv]),o=[[],["TOTALES","","","","","","","",w.totalSinIgv,w.totalConIgv]],d=[s,...a,...o],n=u.aoa_to_sheet(d);n["!autofilter"]={ref:u.encode_range(u.decode_range(n["!ref"]))},n["!freeze"]={xSplit:0,ySplit:1},n["!cols"]=[{wch:12},{wch:10},{wch:12},{wch:40},{wch:10},{wch:16},{wch:16},{wch:14},{wch:14},{wch:14}];const g=u.decode_range("A1:J1");for(let l=g.s.c;l<=g.e.c;l++){const f=n[u.encode_cell({r:0,c:l})];f&&(f.s={font:{bold:!0},fill:{fgColor:{rgb:"FFE6E6FA"}}})}const x=s.length+a.length,S=u.decode_range(`A${x+1}:J${x+1}`);for(let l=S.s.c;l<=S.e.c;l++){const f=n[u.encode_cell({r:x,c:l})];f&&(f.s={font:{bold:!0},fill:{fgColor:{rgb:"FFD3D3D3"}}})}const G="Cotizacion";u.book_append_sheet(t,n,G);const b=new Date,U=`${b.getFullYear()}-${String(b.getMonth()+1).padStart(2,"0")}-${String(b.getDate()).padStart(2,"0")}_${String(b.getHours()).padStart(2,"0")}-${String(b.getMinutes()).padStart(2,"0")}`,J=`cotizacion_${c.ruc||"sin-ruc"}_${U}.xlsx`;K(t,J)};return e.jsxs("div",{className:"min-h-screen bg-gray-100",children:[e.jsx("header",{className:"bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:q,className:"inline-flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg transition-colors",children:[e.jsx("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z",clipRule:"evenodd"})}),"Volver al Catálogo"]}),e.jsx("h1",{className:"text-2xl font-bold",children:"Nueva Cotización"})]})})})}),e.jsxs("main",{className:"max-w-7xl mx-auto px-4 py-6",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-6 border-2 border-blue-100",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-800 mb-4 flex items-center gap-2",children:[e.jsx("svg",{className:"w-6 h-6 text-blue-600",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm3 2a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3z",clipRule:"evenodd"})}),"Datos del Cliente"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["RUC/DNI",!M&&c.ruc&&e.jsx("span",{className:"text-red-500 text-xs ml-2",children:"• Debe ser 8 (DNI) o 11 (RUC) dígitos"})]}),e.jsx("input",{type:"text",className:`w-full border-2 rounded-lg px-3 py-2 focus:ring-2 transition-colors ${!M&&c.ruc?"border-red-300 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}`,placeholder:"Ingrese RUC (11 dígitos) o DNI (8 dígitos)",value:c.ruc,onChange:t=>_("ruc",t.target.value),maxLength:"11"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Razón Social"}),e.jsx("input",{type:"text",className:"w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors",placeholder:"Nombre del cliente o empresa",value:c.nombre,onChange:t=>_("nombre",t.target.value)})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Orden de Compra",!R&&c.oc&&e.jsx("span",{className:"text-red-500 text-xs ml-2",children:"• Solo números permitidos"})]}),e.jsx("input",{type:"text",className:`w-full border-2 rounded-lg px-3 py-2 focus:ring-2 transition-colors ${!R&&c.oc?"border-red-300 focus:ring-red-500 focus:border-red-500":"border-gray-300 focus:ring-blue-500 focus:border-blue-500"}`,placeholder:"Ingrese número de orden de compra",value:c.oc,onChange:t=>_("oc",t.target.value)})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg border-2 border-blue-100 overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Seleccionar Productos para Cotización"}),B&&V&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-200",children:[e.jsx("svg",{className:"w-3 h-3",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),e.jsxs("span",{children:["Selección guardada ",Y(V)]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mb-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",className:"w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors",placeholder:"Buscar productos por código, nombre o descripción...",value:k,onChange:t=>F(t.target.value)})}),e.jsx("div",{className:"w-full sm:w-48",children:e.jsxs("select",{className:"w-full border-2 border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors",value:y,onChange:t=>T(t.target.value),children:[e.jsx("option",{value:"TODAS",children:"Todas las líneas"}),[...new Set(D.map(t=>t.linea).filter(Boolean))].sort().map(t=>e.jsx("option",{value:t,children:t},t))]})})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm text-left text-gray-500",children:[e.jsx("thead",{className:"text-xs text-gray-700 uppercase bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:e.jsx("input",{type:"checkbox",onChange:t=>{if(t.target.checked){const s=P.map(a=>({product:a,quantity:1,manualDiscounts:[0,0]}));h(s)}else h([])},className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"})}),e.jsx("th",{scope:"col",className:"px-4 py-3",children:"Código"}),e.jsx("th",{scope:"col",className:"px-4 py-3",children:"Nombre"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:"Stock"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:"Cantidad"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-right",children:"Precio s/IGV"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-right",children:"Precio c/IGV"})]})}),e.jsx("tbody",{children:P.map(t=>{const s=m.find(o=>o.idx===t.idx),a=!!s;return e.jsxs("tr",{className:`border-b hover:bg-gray-50 ${a?"bg-blue-50":""}`,children:[e.jsx("td",{className:"px-4 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:a,onChange:()=>L(t),className:"w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"})}),e.jsx("td",{className:"px-4 py-2 font-mono font-medium text-gray-900",children:t.codigo}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("div",{className:"font-medium text-sm leading-tight break-words line-clamp-2 hover:line-clamp-none hover:whitespace-normal transition-all duration-200 cursor-help",title:t.nombre,children:t.nombre})}),e.jsx("td",{className:"px-4 py-2 text-center",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-bold ${(t.stock||0)>20?"bg-green-100 text-green-800":(t.stock||0)>10?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:t.stock||0})}),e.jsx("td",{className:"px-4 py-2 text-center",children:a?e.jsx("input",{type:"number",min:"1",className:"w-20 border border-gray-300 rounded-md px-2 py-1 text-center font-mono",value:Math.round(s.quantity),onChange:o=>E(t.idx,"quantity",o.target.value)}):e.jsx("span",{className:"text-gray-400",children:"-"})}),e.jsx("td",{className:"px-4 py-2 text-right font-mono",children:a?i(s.unitPrice):i(t.precio_lista)}),e.jsx("td",{className:"px-4 py-2 text-right font-mono",children:a?i(s.unitPrice*(1+C)):i(t.precio_lista*(1+C))})]},t.idx)})})]})})]}),m.length>0&&e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-6 border-2 border-green-100",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:"Resumen de Cotización"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm text-left text-gray-500",children:[e.jsx("thead",{className:"text-xs text-gray-700 uppercase bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-4 py-3",children:"Código"}),e.jsx("th",{scope:"col",className:"px-4 py-3",children:"Nombre"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:"Cantidad"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-right",children:"Precio Base"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:"Desc. Cliente (%)"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:"Desc. Producto (%)"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-right",children:"Precio Unitario"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-right",children:"Subtotal"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-right",children:"Total c/IGV"}),e.jsx("th",{scope:"col",className:"px-4 py-3 text-center",children:"Acción"})]})}),e.jsx("tbody",{children:m.map(t=>e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 font-mono font-medium text-gray-900",children:t.codigo}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("div",{className:"font-medium text-sm leading-tight break-words line-clamp-2 hover:line-clamp-none hover:whitespace-normal transition-all duration-200 cursor-help",title:t.nombre,children:t.nombre})}),e.jsx("td",{className:"px-4 py-2 text-center font-mono",children:Math.round(t.quantity)}),e.jsx("td",{className:"px-4 py-2 text-right font-mono",children:i(t.precio_lista)}),e.jsx("td",{className:"px-4 py-2 text-center font-mono text-sm",children:t.descSuma01?(Math.round(t.descSuma01*100)/100).toFixed(2)+"%":"0.00%"}),e.jsx("td",{className:"px-4 py-2 text-center font-mono text-sm",children:t.descSuma02?(Math.round(t.descSuma02*100)/100).toFixed(2)+"%":"0.00%"}),e.jsx("td",{className:"px-4 py-2 text-right font-mono",children:i(t.unitPrice)}),e.jsx("td",{className:"px-4 py-2 text-right font-mono font-bold text-green-700",children:i(t.totalSinIgv)}),e.jsx("td",{className:"px-4 py-2 text-right font-mono font-bold text-blue-700",children:i(t.totalConIgv)}),e.jsx("td",{className:"px-4 py-2 text-center",children:e.jsx("button",{onClick:()=>L(t),className:"text-red-500 hover:text-red-700",children:e.jsx("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})})})})]},t.idx))})]})})]}),m.length>0&&e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 border-2 border-gray-100",children:[e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center text-lg font-bold border-b border-gray-300 pb-2",children:[e.jsx("span",{className:"text-gray-800",children:"Subtotal (sin IGV):"}),e.jsx("span",{className:"text-green-600",children:i(w.totalSinIgv)})]}),e.jsxs("div",{className:"flex justify-between items-center text-xl font-bold",children:[e.jsx("span",{className:"text-gray-800",children:"Total (con IGV):"}),e.jsx("span",{className:"text-blue-600",children:i(w.totalConIgv)})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>{h([]),localStorage.removeItem("cotizacion_seleccion"),v(!1),N(null)},className:"flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2",children:[e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z",clipRule:"evenodd"})}),"Limpiar Selección"]}),e.jsxs("button",{onClick:O,className:"flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex items-center justify-center gap-2",children:[e.jsx("svg",{className:"w-5 h-5",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z",clipRule:"evenodd"})}),"Generar Cotización"]})]})]})]})]})}export{te as default};
